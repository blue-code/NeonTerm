"use strict";const n=require("electron"),w=require("ssh2"),p=require("path"),d=require("fs");let u;const g=p.join(n.app.getPath("userData"),"neonterm-sessions.json");function D(){if(!d.existsSync(g))return{groups:[],sessions:[]};try{return JSON.parse(d.readFileSync(g,"utf-8"))}catch{return{groups:[],sessions:[]}}}function S(e){d.writeFileSync(g,JSON.stringify(e,null,2))}function E(){u=new n.BrowserWindow({width:1400,height:900,webPreferences:{preload:p.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!1,webSecurity:!1}}),process.env.VITE_DEV_SERVER_URL?u.loadURL(process.env.VITE_DEV_SERVER_URL):u.loadFile(p.join(__dirname,"../dist/index.html"))}n.app.whenReady().then(E);let y=null,c=".",h=null;function M(e,s){h&&clearInterval(h);const t=()=>{e.exec(`
      echo "LOAD:$(cat /proc/loadavg | awk '{print $1}')"
      free -m | awk 'NR==2{printf "MEM:%s/%sMB %.1f%%", $3, $2, $3*100/$2}'
      df -h / | awk 'NR==2{printf "DISK:%s/%s (%s)", $3, $2, $5}'
    `,(a,r)=>{if(a)return;let o="";r.on("data",l=>{o+=l.toString()}),r.on("close",()=>{const l={};o.split(`
`).forEach(f=>{f.startsWith("LOAD:")&&(l.cpu=`Load: ${f.substring(5)}`),f.startsWith("MEM:")&&(l.mem=f.substring(4)),f.startsWith("DISK:")&&(l.disk=f.substring(5))}),s.reply("server-stats",l)})})};t(),h=setInterval(t,5e3)}n.ipcMain.on("connect-ssh",(e,s)=>{const t=new w.Client;try{s.privateKey&&(s.privateKey=d.readFileSync(s.privateKey))}catch(i){e.reply("ssh-error","Key Load Error: "+i.message);return}t.on("ready",()=>{e.reply("ssh-ready"),M(t,e),t.shell((i,a)=>{if(i)return e.reply("ssh-error",i.message);a.on("close",()=>{e.reply("ssh-closed"),h&&clearInterval(h),t.end()}).on("data",r=>{e.reply("term-data",r.toString())}),n.ipcMain.on("term-input",(r,o)=>{a.write(o)}),t.sftp((r,o)=>{r||(y=o,m(e))})})}).on("error",i=>{e.reply("ssh-error",i.message)}).connect(s)});function m(e){y&&y.readdir(c,(s,t)=>{if(s)return;const i=t.sort((a,r)=>{const o=a.attrs.mode&16384?1:0;return(r.attrs.mode&16384?1:0)-o});e.reply("sftp-list",{path:c,files:i})})}n.ipcMain.on("sftp-navigate",(e,s)=>{s===".."?c=p.dirname(c):c=p.join(c,s).replace(/\\/g,"/"),m(e)});n.ipcMain.on("sftp-upload",(e,s)=>{y&&s.forEach(t=>{const i=p.basename(t),a=p.join(c,i).replace(/\\/g,"/");y.fastPut(t,a,r=>{r?console.error("Upload failed",r):m(e)})})});n.ipcMain.handle("get-sessions",()=>D());n.ipcMain.handle("save-sessions",(e,s)=>S(s));n.ipcMain.handle("dialog-open-file",async()=>await n.dialog.showOpenDialog(u,{properties:["openFile"],filters:[{name:"Key Files",extensions:["pem","ppk","key","txt","*"]}]}));n.ipcMain.handle("import-sessions",async()=>{const{filePaths:e}=await n.dialog.showOpenDialog(u,{properties:["openFile"],filters:[{name:"JSON Files",extensions:["json"]}]});if(e.length>0){const s=JSON.parse(d.readFileSync(e[0],"utf-8"));return S(s),s}return null});n.ipcMain.handle("export-sessions",async(e,s)=>{const{filePath:t}=await n.dialog.showSaveDialog(u,{defaultPath:"neonterm-sessions.json",filters:[{name:"JSON Files",extensions:["json"]}]});return t?(d.writeFileSync(t,JSON.stringify(s,null,2)),!0):!1});
